(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{445:function(e,t,o){"use strict";o.r(t);var a=o(35),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h1",{attrs:{id:"sentry-node-architecture"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#sentry-node-architecture"}},[e._v("#")]),e._v(" Sentry Node Architecture")]),e._v(" "),o("blockquote",[o("p",[o("strong",[e._v("Tip")]),e._v(":")]),e._v(" "),o("p",[e._v("Part of this document is copied from "),o("a",{attrs:{href:"https://forum.cosmos.network/t/sentry-node-architecture-overview/454",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),o("OutboundLink")],1),e._v(".\nYou can also learn more about validator security through "),o("a",{attrs:{href:"https://docs.tendermint.com/master/nodes/validators.html#setting-up-a-validator",target:"_blank",rel:"noopener noreferrer"}},[e._v("Tendermint Documents"),o("OutboundLink")],1),e._v(".")])]),e._v(" "),o("h3",{attrs:{id:"disclaimer"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#disclaimer"}},[e._v("#")]),e._v(" Disclaimer")]),e._v(" "),o("p",[e._v("It is important to understand that this is only one example of solving DDoS mitigation for validator nodes. For diversity in the network, validators are encouraged to implement their own solutions. Each validator is responsible for their own solution. This example might be missing crucial security features that need to be implemented for production use.")]),e._v(" "),o("h3",{attrs:{id:"problem-description"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#problem-description"}},[e._v("#")]),e._v(" Problem description")]),e._v(" "),o("p",[e._v("On the MetaOS network, a validator node can be attacked using the Distributed Denial of Service method. The validator node has a fixed IP address and opens a RESTful API port facing the Internet.")]),e._v(" "),o("h3",{attrs:{id:"proposed-solution"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#proposed-solution"}},[e._v("#")]),e._v(" Proposed solution")]),e._v(" "),o("p",[e._v("To mitigate the issue, multiple distributed nodes (sentry nodes) are deployed in cloud environments. With the possibility of easy scaling, it is harder to make an impact on the validator node. New sentry nodes can be brought up during a DDoS attack and using the gossip network they can be integrated into the transaction flow.")]),e._v(" "),o("h3",{attrs:{id:"network-layout"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#network-layout"}},[e._v("#")]),e._v(" Network layout")]),e._v(" "),o("p",[o("img",{attrs:{src:"/docs/static/sentry_layout.png",alt:"network-layout"}})]),e._v(" "),o("p",[e._v("The solution provided here is based on Amazon AWS services. Google Cloud has similar solutions to solve this issue.")]),e._v(" "),o("p",[e._v("The proposed network diagram is similar to the classical backend/frontend separation of services in a corporate environment. The “backend” in this case is the private network of the validator in the data center. The data center network might involve multiple subnets, firewalls and redundancy devices, which is not detailed on this diagram. The important point is that the data center allows direct connectivity to the chosen cloud environment. Amazon AWS has “Direct Connect”, while Google Cloud has “Partner Interconnect”. This is a dedicated connection to the cloud provider (usually directly to your virtual private cloud instance in one of the regions).")]),e._v(" "),o("p",[e._v("All sentry nodes (the “frontend”) connect to the validator using this private connection. The validator does not have a public IP address to provide its services.")]),e._v(" "),o("p",[e._v("Amazon has multiple availability zones within a region. One can install sentry nodes in other regions too. In this case the second, third and further regions need to have a private connection to the validator node. This can be achieved by VPC Peering (“VPC Network Peering” in Google Cloud). In this case, the second, third and further region sentry nodes will be directed to the first region and through the direct connect to the data center, arriving to the validator.")]),e._v(" "),o("p",[e._v("A more persistent solution (not detailed on the diagram) is to have multiple direct connections to different regions from the data center. This way VPC Peering is not mandatory, although still beneficial for the sentry nodes. This overcomes the risk of depending on one region. It is more costly.")]),e._v(" "),o("h3",{attrs:{id:"local-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#local-configuration"}},[e._v("#")]),e._v(" Local configuration")]),e._v(" "),o("p",[o("img",{attrs:{src:"/docs/static/local_config.png",alt:"local-config"}})]),e._v(" "),o("p",[e._v("The validator is only going to talk to the sentry nodes, while sentry nodes have the ability to talk to the validator node on the private channel and talk to public nodes elsewhere on the Internet. Optionally, they could be set up to talk to each other on the private network too.")]),e._v(" "),o("p",[e._v("The "),o("code",[e._v("config.toml")]),e._v(" configuration is going to determine the logical setup of the network. Four parameters define how a node communicates:")]),e._v(" "),o("ul",[o("li",[o("code",[e._v("pex")]),e._v(": boolean value. It turns the peer exchange reactor (gossip protocol) on or off in a node. When "),o("code",[e._v("pex=false")]),e._v(", only the list of nodes in the "),o("code",[e._v("persistent_peers")]),e._v(" list are available for connection.")]),e._v(" "),o("li",[o("code",[e._v("persistent_peers")]),e._v(": comma-separated list of "),o("code",[e._v("nodeid@ip:port")]),e._v(" values that define a list of peers that are expected to be online at all times and the node is expected to be able to connect to them. This is necessary at first startup so the node has a few other nodes to connect to. It is not as crucial when the peer exchange reactor already filled with a list of nodes that are available. If some nodes are not available, they will be skipped and later retried for a while before completely dropping them. If no nodes are available from this list and "),o("code",[e._v("pex=false")]),e._v(", then the node will not be able to join the network.")]),e._v(" "),o("li",[o("code",[e._v("private_peer_ids")]),e._v(": comma-separate list of nodeid values, that should not be gossiped at all times. This setting tells which nodes should not be handed out to others, when "),o("code",[e._v("pex=true")]),e._v(". If "),o("code",[e._v("pex=false")]),e._v(", this setting can be omitted.")]),e._v(" "),o("li",[o("code",[e._v("addr_book_strict")]),e._v(": boolean value with a twisted name. In short, turn this off if someone of the nodes are on a LAN IP. By default, only nodes with a routable address will be considered for connection. This is what “strict” address book means. If this setting is turned off (false), non-routable IP addresses, like addresses in a private network, can be added to the address book.")])]),e._v(" "),o("h3",{attrs:{id:"validator-node-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#validator-node-configuration"}},[e._v("#")]),e._v(" Validator node configuration")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[e._v("Config Option")]),e._v(" "),o("th",[e._v("Setting")])])]),e._v(" "),o("tbody",[o("tr",[o("td",[e._v("pex")]),e._v(" "),o("td",[e._v("false")])]),e._v(" "),o("tr",[o("td",[e._v("persistent_peers")]),e._v(" "),o("td",[e._v("list of sentry nodes")])]),e._v(" "),o("tr",[o("td",[e._v("private_peer_ids")]),e._v(" "),o("td",[e._v("omitted")])]),e._v(" "),o("tr",[o("td",[e._v("addr_book_strict")]),e._v(" "),o("td",[e._v("false")])])])]),e._v(" "),o("p",[e._v("The validator node should have "),o("code",[e._v("pex=false")]),e._v(" set, so it doesn't even try to gossip. The validator node will only communicate with the sentry nodes. The sentry nodes should be added to the "),o("code",[e._v("persistent_peers")]),e._v(" list, so the validator is able to connect to them. As "),o("code",[e._v("pex=false")]),e._v(", the "),o("code",[e._v("private_peer_ids")]),e._v(" setting can be omitted. Since the validator is on a private network and it will connect to the sentry nodes also on a private network, "),o("code",[e._v("addr_book_strict=false")]),e._v(" has to be set.")]),e._v(" "),o("h3",{attrs:{id:"sentry-node-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#sentry-node-configuration"}},[e._v("#")]),e._v(" Sentry node configuration")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[e._v("Config Option")]),e._v(" "),o("th",[e._v("Setting")])])]),e._v(" "),o("tbody",[o("tr",[o("td",[e._v("pex")]),e._v(" "),o("td",[e._v("true")])]),e._v(" "),o("tr",[o("td",[e._v("persistent_peers")]),e._v(" "),o("td",[e._v("validator node, optionally other sentry nodes")])]),e._v(" "),o("tr",[o("td",[e._v("private_peer_ids")]),e._v(" "),o("td",[e._v("validator node id")])]),e._v(" "),o("tr",[o("td",[e._v("addr_book_strict")]),e._v(" "),o("td",[e._v("false")])])])]),e._v(" "),o("p",[e._v("The sentry nodes should be able to talk to nodes on the Internet, and they should benefit from the peer exchange reactor, hence "),o("code",[e._v("pex=true")]),e._v(" is set. They should also make sure they don't gossip the validator node id and IP address, hence the "),o("code",[e._v("private_peer_ids")]),e._v(" should contain the validator node's ID. Also, the validator node is expected to be up and running and since it's not gossip-ed, the only way to connect to it is to add it to the "),o("code",[e._v("persistent_peers")]),e._v(" list. Because the validator is on a private network, "),o("code",[e._v("addr_book_strict=false")]),e._v(" needs to be set.")]),e._v(" "),o("p",[e._v("It was implied that sentry nodes have both a public and a private address but only the public IP should be gossip-ed. This can be achieved by explicitly setting the "),o("code",[e._v("--external-ip")]),e._v(" setting during the init of the sentry node.")]),e._v(" "),o("h3",{attrs:{id:"challenges"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#challenges"}},[e._v("#")]),e._v(" Challenges")]),e._v(" "),o("h4",{attrs:{id:"direct-connection"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#direct-connection"}},[e._v("#")]),e._v(" Direct connection")]),e._v(" "),o("p",[e._v("Although both Google Cloud and Amazon AWS have direct connection capabilities, costs can go up quickly when multiple direct connections are established to the data center. The network configuration becomes convoluted too.")]),e._v(" "),o("p",[e._v("On the other hand, it is the only way to make cloud connectivity redundant. If the region where the direct connection is established goes down, the regions connected using VPC peering lose connection to the validator.")]),e._v(" "),o("p",[e._v("Also, not all data centers have direct connect capabilities. Check the relevant documentation in the cloud and with the data center.")]),e._v(" "),o("h4",{attrs:{id:"dynamic-scaling"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#dynamic-scaling"}},[e._v("#")]),e._v(" Dynamic scaling")]),e._v(" "),o("p",[e._v("The sentry node architecture in the cloud begs for automated scaling. Unfortunately to add a new sentry node to the network, there are few challenges.")]),e._v(" "),o("ul",[o("li",[e._v("The "),o("code",[e._v("persistent_peers settings")]),e._v(" in the configuration need to be updated and the service reloaded at least on the validator. This requires some kind of configuration management that is out of scope for "),o("code",[e._v("tendermint")]),e._v(" right now. (Look into Devops tooling)")]),e._v(" "),o("li",[e._v("The new node will take a long time to sync if it has to start from scratch. It's an interesting idea to save the blockchain state from other nodes at a regular basis (for example to S3 or by snapshotting an instance) and deploy that when a new node is added. The added complexity requires the scaling services like CloudFormation and AutoScaling to add extra logic for proper deployment.")])]),e._v(" "),o("h4",{attrs:{id:"ops"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#ops"}},[e._v("#")]),e._v(" Ops")]),e._v(" "),o("p",[e._v("The validator node doesn't require a public Internet connection for its service, but it still requires maintenance, security updates and monitoring. This can be achieved through a server hosted in the cloud, or a separate Internet connection in the data center (preferably with VPN connectivity). It is strongly recommended to hire/contract someone with operations experience for a secure setup.")]),e._v(" "),o("p",[e._v("The sentry nodes require maintenance and security updates too. Since they have a public-facing interface, extra care need to be taken for proper maintenance. For example, we don't want to end up with snapshots that contain malware, that was introduced on an instance earlier.")]),e._v(" "),o("h4",{attrs:{id:"why-not-all-in-with-the-cloud"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#why-not-all-in-with-the-cloud"}},[e._v("#")]),e._v(" Why not all-in with the cloud?")]),e._v(" "),o("p",[e._v("Putting the validator in the cloud has technical difficulties. The KMS services provided by Amazon and Google are missing someone of the algorithms that Tendermint is using. Setting up a validator without KMS is a big security risk for production use.")]),e._v(" "),o("p",[e._v("The other issue is that VPC Peering is not available among different cloud providers. The alternative option is VPN over public Internet. Or the validator is locked into one cloud provider, which is also a risk.")]),e._v(" "),o("h4",{attrs:{id:"other-attacks-to-resolve"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#other-attacks-to-resolve"}},[e._v("#")]),e._v(" Other attacks to resolve")]),e._v(" "),o("p",[e._v("The DDoS attack described here is not the only attack to be resolved for a validator node. For example the HTTP port open to the Internet is susceptible for man-in-the-middle attacks. Although this attack doesn't impact the MetaOS network, it can impact the validator node. A malicious attacker can present an altered state of the network to the validator node and force it to behave incorrectly from the network perspective - which can lead to slashing of the validator node's tokens. The SNA does not target to resolve this, however it provides some coverage by making the man-in-the-middle attack harder, because of the multiple sentry nodes.")]),e._v(" "),o("h3",{attrs:{id:"summary"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[e._v("#")]),e._v(" Summary")]),e._v(" "),o("p",[e._v("The above solution provides a way to hide the IP address of the validator node and provide a more easily scalable list of public IP addresses for DDoS mitigation. As mentioned before, this is one such proposed architecture and hopefully more will surface in the community with active discussion around them.")])])}),[],!1,null,null,null);t.default=n.exports}}]);